pipeline {
    agent any
    tools {
    maven 'M2'
    }
    stages {
        stage('checkout') {
            steps {
                git 'https://github.com/Shi191099/JavaCode.git'
            }
        }
        stage('build') {
            steps {
                sh 'mvn clean install'
            }
        }

        stage('SonarQube Analysis') {
            steps {
              withSonarQubeEnv('sonar') {
                sh "mvn clean verify sonar:sonar"
                }
             }
    	}
    	stage('Execute Sonarqube Report')  {
            steps {
                withSonarQubeEnv('sonar') {
                    sh "mvn sonar:sonar"
                }  
            }
        }
        stage('Quality Gate Check') {
            steps {
                waitForQualityGate abortPipeline: true
                
            }
        }
        stage ('Upload Artifact to Nexus') {
            steps {
                nexusArtifactUploader artifacts: [
                    [
                        artifactId: 'maven-project', 
                        classifier: '', 
                        file: 'webapp/target/webapp.war', 
                        type: 'war'
                    ]
                ], 
                credentialsId: 'nexus1', 
                groupId: 'com.example.maven-project', 
                nexusUrl: '13.41.191.29:8081', 
                nexusVersion: 'nexus3', 
                protocol: 'http', 
                repository: 'Nexus-Artifact', 
                version: '1.0.0'
            }
        }
        
        stage ('deploy') {
            steps {
                deploy adapters: [
                    tomcat9(
                        credentialsId: 'tomcat', 
                        path: '', 
                        url: 'http://52.56.48.59:9090'
                        )
                ], 
                contextPath: 'web-java', 
                war: 'webapp/target/webapp.war'
            }
        }
        stage('E-mail Approval') {
		    steps {
	        	emailext mimeType: 'text/html', subject: "[Jenkins]${currentBuild.fullDisplayName}",
	        	to: 'ashi191099@gmail.com',
	        	body: '''<h1>Deployed</h1>'''
	       }
	   }
    }
}
